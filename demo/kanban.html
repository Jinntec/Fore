<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, minimum-scale=1, initial-scale=1, task-scalable=yes" name="viewport"/>

    <title>Kanban Board</title>


    <link href="../resources/fore.css" rel="stylesheet">
    <!--    <link href="../resources/vars.css" rel="stylesheet">-->
        <link href="../resources/demo.css" rel="stylesheet">

    <script type="module">
        import {XPathUtil} from "../src/xpath-util.js";
    </script>

    <style>

        body{
            font-family: Montserrat, Verdana, sans-serif;
            padding: 0;
        }
        .card{
            padding:1rem;
            margin:0.3rem 0;
            border-radius: 5px;
            background: white;
            display: grid;
            grid-template-areas: "task icon"
                                 "content content";
        }
        .task{
            grid-area: task;
        }
        .iconbtn{
            grid-area: icon;
        }
        .card-content{
            grid-area:content;
        }

        #column{
            height: 75vh;
        }
        label{
            display: block;
        }
        [repeat-index]{
            background: rgba(255,255,255,0.5);
        }
        .droptarget{
            background: #00c853;
        }

        .drag-over{
            border:thin solid #dddddd;
            background: orange;
            /*padding:1rem 0;*/
            /*transform: scaleY(105%);*/
            /*padding: 1rem 0;*/
        }
        .dropTarget{
            /*height: 1rem;*/
            height: 0;
            width: 100%;
            background: var(--paper-grey-300);
            border-radius: 0.5rem;
            transition: height 0.2s;
        }
        .dropTarget.drag-over{
            height: 1rem;
        }



        fx-control{
            width: 100%;
            position:relative;
        }
        fx-fore{
            height: 100vh;
        }
        fx-repeat{
            position:relative;
        }
        fx-repeatitem{
            display: block;
            min-width: 200px;
            position:relative;
        }
        .ghost{
            height:3rem;
            background: #dddddd;
        }
        input{
            width: calc(100% - 0.5rem);
            border: none;
            padding: 4px;
            background: white;
            font-size: 1rem;
        }
        /* project repeat */
        .iconbtn{
            position: absolute;
            right:1rem;
        }
        .iconbtn button:hover{
            background: grey;
            color:white;
        }
        .deleteProject{
            right: 2rem;
            position: absolute;
        }
        .iconbtn button{
            border-radius: 50%;
            border:none;
            color:black;
            background: white;
        }
        .addProject{
            right: 0.5rem;
        }
        .iconbtn.addcolumn{
            right:2.5rem;
        }

        #column{
            display: grid !important;
            /*grid-template-columns: repeat(3,1fr);*/
            grid-gap: 1rem;
            overflow: auto;
            width: 100%;
        }
        .header {
            /* border-bottom: thin solid white; */
            padding: 1rem;
            display: grid;
            grid-template-columns: auto 1rem 1rem;
        }
        .header input{
            background: var(--paper-light-blue-500);
            border-radius: 1rem;
            width: 80px;
            color: white;
            text-align: center;
        }

        .header.doing input{
            background: var(--paper-orange-500);
        }

        .header.done input{
            background: var(--paper-green-500);
        }

        #column > fx-repeatitem{
            background: var(--paper-grey-100);
            position: relative;
            min-width: 300px;
            padding:0.5rem 0.25rem;
        }
        #column > [repeat-index]{
            border:thin solid var(--paper-grey-500);
        }
        #column .header > fx-control{
            width: calc(100% - 5rem);
        }
        .handle{
            width: 1rem;
            height: 1rem;
            /* background: lightgrey; */
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);        }
        .line{
            background: black;
            display: block;
            height: 1px;
            width: 100%;
            margin-bottom: 4px;
        }
        .subheader{
            font-size: 0.9rem;
            font-weight: 700;
            margin-top:1rem;
        }
        .activity{
            width: 100%;
            display: block;
        }
        .priority:before{
            /*color:white;*/
            width:16px;
            height: 16px;
            padding: 2px;
            display: inline-block;
            text-align: center;
            border-radius: 14px;
            content:'';
        }
        .priority.p1:before{
            /*content:'highest';*/
            background: red;
        }
        .priority.p2:before{
            /*content:'high';*/
            background: orange;
        }
        .priority.p3:before{
            /*content:'medium';*/
            background: dodgerblue;
        }
        .priority.p4:before{
            /*content:'forget it';*/
            background: green;
        }

        #r-task .iconbtn{
            right: 1.5rem;
        }

        .wrapper{
            width:auto;
            max-width: 100%;
        }

        #r-task{
            height: 100%;
        }
        .margin-top{
            padding-top:2rem;
        }
        .margin-bottom{
            padding-bottom:2rem;
        }
        .up::before{
            content:'';
            height: 3rem;
            background: #dddddd;
            border:thin solid #666666;
            width: 100%;
        }
        .down::after{
            content:'';
            height: 3rem;
            background: pink;
            border:thin solid #666666;
            width: 100%;
        }
    </style>
</head>
<body>
<fore-corner href="../doc/demos.html" title="Back to Demos"></fore-corner>
<div class="wrapper">
    <fx-fore>
        <fx-model>
            <fx-instance>
                <data>
                    <column name="todo">
                        <task name="launch preps"></task>
                    </column>
                    <column name="doing">
                        <task name="press investors for more money"></task>
                        <task name="playing"></task>
                    </column>
                    <column name="done">
                        <task name="tidy up office"></task>
                        <task name="worst case"></task>
                    </column>
                    <template>
                        <column name=""></column>
                        <task name="newTask">new task</task>
                    </template>
                    <confirm>false</confirm>
                </data>
            </fx-instance>
        </fx-model>
        <h1>Kanban Board</h1>

        <fx-repeat id="column" dnd="true" ref="column"  style="grid-template-columns: repeat({count(instance()/column)},1fr);">
            <template>
                <div class="header {@name}">
                    <fx-control ref="@name"></fx-control>
                    <fx-trigger class="iconbtn addcolumn" title="add card">
                        <button>+</button>
                        <fx-insert ref="task" at="1" position="before" origin="instance()/template/task"></fx-insert>
                        <fx-refresh></fx-refresh>
                        <fx-setfocus control="task"></fx-setfocus>
                    </fx-trigger>
                    <fx-trigger class="iconbtn deletecolumn">
                        <button>x</button>
                        <fx-delete ref="." if="instance('default')/confirm"></fx-delete>
                    </fx-trigger>
                </div>
<!--                <div>-->
                    <fx-repeat id="r-task" ref="task" dnd="true" tabindex="0" data-cy="{@name}">
                        <template draggable="true">
                            <div class="card" tabindex="1" data-cy="{../@name}-{count(preceding-sibling::task)}" data-cy-name="{@name}">
                                <fx-control id="task" class="task" ref="@name"></fx-control>
                                <fx-trigger class="iconbtn" title="delete card">
                                    <button>x</button>
                                    <fx-delete ref="."></fx-delete>
                                </fx-trigger>
                                <div class="card-content"></div>
<!--
                                <div class="handle">
                                    <span class="line"></span>
                                    <span class="line"></span>
                                    <span class="line"></span>
                                </div>
-->
                            </div>
                        </template>

<!--
						<fx-action event="fx-drop">
						  <fx-delete ref="event('dragging-item')"></fx-delete>
						  <fx-insert ref="event('dragging-item')" at="event('drop-index')"></fx-insert>
						  <fx-setvalue ref="@status" value="open"></fx-setvalue>
						</fx-action>
-->
                    </fx-repeat>
<!--                </div>-->
            </template>
        </fx-repeat>


        <div class="buttons">
            <fx-trigger>
                <button>insert a column</button>
                <fx-insert ref="column" at="index('column')" position="before" origin="template/column"></fx-insert>
            </fx-trigger>
            <fx-trigger>
                <button>Append new column</button>
                <fx-insert ref="column"></fx-insert>
            </fx-trigger>
        </div>

        <fx-action-log></fx-action-log>
    </fx-fore>


</div>
<!--<script>

    const fore = document.querySelector('fx-fore');
    let draggedItem;
    let droptarget;
    fore.addEventListener('ready', e => {

        console.log('attach dnd script');
        const elements = document.querySelectorAll('[draggable]');
        const repeat = elements[0].parentNode;
        console.log('repeat to dnd', repeat);

        Array.from(elements).forEach(elem => {
            elem.addEventListener('dragstart', e => {
                // console.log('dragstart',e);
                e.dataTransfer.dropEffect = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
                draggedItem = e.target;
            });

            elem.addEventListener('dragover', e => {
                e.preventDefault();
                e.stopPropagation();
                // console.log('dragover',e);

                const repeatItem = e.target.closest('fx-repeatitem');
                // console.log('dragover repeatItem',repeatItem);

                if(repeatItem !== draggedItem){
                    // const itemHeight = repeatItem.offsetHeight;


                    repeatItem.classList.add('drag-over');
                    // const dummy = document.createElement('fx-repeatitem');
/*
                    if(droptarget) return;
                    setTimeout((e,repeatItem) => {
                        if(e.offsetY > itemHeight / 2){
                        // repeatItem.before(dummy);
                        repeatItem.classList.toggle('up');
                        }else {
                            // repeatItem.after(dummy);
                            repeatItem.classList.toggle('down');
                        }
                    },400);
*/
                    // droptarget = dummy;



                }
            })

            elem.addEventListener('dragleave', e => {
                // console.log('dragleave',e);
                e.target.classList.remove('drag-over');

            })

            elem.addEventListener('drop', e => {
                console.log('drop',e);
                e.target.closest('fx-repeatitem').classList.remove('drag-over');
                e.preventDefault();
                e.stopPropagation();
                const droppedElement = e.dataTransfer.getData('text/html');
                // console.log('dropped element', droppedElement);

                const dataNode = draggedItem.getModelItem().node;
                const parent = dataNode.parentNode;
                console.log('ModelItem',dataNode);



                if(e.target.nodeName === 'FX-REPEAT'){
                    console.log('drop onto repeat',e.target);

                    parent.removeChild(dataNode);
                    const targetRepeat = e.target;
                    const targetNodeset = targetRepeat.getModelItem().node;


                    if(Array.isArray(targetNodeset)){
                        if(targetNodeset.length === 0){
                            parent.append(dataNode);
                        }else{
                            // todo: still a bug around here
                            // targetNodeset[0].parentNode.append(dataNode);// re-append
                            parent.append(dataNode);
                        }
                    }else{
                        targetNodeset.parentNode.append(dataNode);// re-append
                    }

                    document.querySelector('fx-fore').dispatchEvent(
                        new CustomEvent('refresh', {
                        composed: false,
                        bubbles: true,
                        detail:{force:true},
                    }));

                    return;

                }
                const repeatItem = e.target.closest('fx-repeatitem');
                console.log('drop onto item',repeatItem);


                if(e.target.nodeName !== 'FX-REPEATITEM'){
                    const parentItem = e.target.closest('fx-repeatitem');

                }

/*
                if(!repeatItem.parentNode.contains(draggedItem)){
                    return;
                }
*/

                if(!repeatItem){
                    draggedItem.parentNode.append(draggedItem);
                }

                if(repeatItem !== draggedItem){
                    const itemHeight = repeatItem.offsetHeight;

                    console.log('itemHeight', itemHeight)
                    console.log('offsetY', e.offsetY)
                    if(e.offsetY > itemHeight / 2 ){
                        console.log('drop after data',repeatItem.getModelItem().node);
                        const repeatItemNode = repeatItem.getModelItem().node;

                        // repeatItem.after(draggedItem);
                        repeatItemNode.after(dataNode.cloneNode(true));
                        dataNode.parentNode.removeChild(dataNode);


                    }else{
                        console.log('drop before data',repeatItem.getModelItem().node);
                        const repeatItemNode = repeatItem.getModelItem().node;
                        // draggedItem.parentNode.insertBefore(draggedItem,repeatItem);

                        repeatItemNode.before(dataNode.cloneNode(true));
                        parent.removeChild(dataNode);

                        console.log('data',dataNode.ownerDocument)

                    }
                    //
                    document.querySelector('fx-fore').dispatchEvent(
                        new CustomEvent('refresh', {
                            composed: false,
                            bubbles: true,
                            detail:{force:true},
                        }));
                }

                // e.target.innerHTML=droppedElement;

            })

        });
    });
</script>-->
<script type="module" src="./demo.js"></script>
</body>
</html>
