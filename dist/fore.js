import{getBucketsForNode as e,evaluateXPath as t,registerCustomXPathFunction as s,registerXQueryModule as n,evaluateXPathToFirstNode as i,evaluateXPathToBoolean as o,evaluateXPathToNodes as r,evaluateXPathToString as a}from"fontoxpath";import"@polymer/iron-ajax/iron-ajax.js";import"@polymer/iron-icon/iron-icon.js";import"@polymer/iron-icons/iron-icons.js";import"@polymer/paper-button/paper-button.js";import"@polymer/paper-dialog/paper-dialog.js";import"@polymer/paper-icon-button/paper-icon-button.js";import"@vaadin/vaadin-notification/vaadin-notification.js";import{css as l,html as d}from"lit-element";import"@vanillawc/wc-codemirror/index.js";import"@vanillawc/wc-codemirror/mode/xml/xml.js";import"@polymer/polymer/polymer-legacy.js";import"@polymer/marked-element/marked-element.js";import"@polymer/prism-element/prism-highlighter.js";import"@polymer/prism-element/prism-theme-default.js";import{Polymer as h}from"@polymer/polymer/lib/legacy/polymer-fn.js";import{dom as c}from"@polymer/polymer/lib/legacy/polymer.dom.js";import{html as u}from"@polymer/polymer/lib/utils/html-tag.js";import"@polymer/iron-flex-layout/iron-flex-layout.js";import"@polymer/font-roboto/roboto.js";class p{constructor(e){this._onNodeTouched=e}getAllAttributes(e,t){return Array.from(e.attributes)}getAttribute(e,t){return e.getAttribute(t)}getChildNodes(t,s){return Array.from(t.childNodes).filter(t=>!s||e(t).includes(s))}getData(e){return e.nodeType===Node.ATTRIBUTE_NODE?(this._onNodeTouched(e),e.value):(this._onNodeTouched(e.parentNode),e.data)}getFirstChild(t,s){const n=Array.from(this.getChildNodes()).filter(t=>!s||e(t).includes(s))[0];return n||null}getLastChild(t,s){const n=n[t.getChildNodes().filter(t=>!s||e(t).includes(s)).length-1];return n||null}getNextSibling(t,s){for(let{nextSibling:n}=t;n;n=n.nextSibling)if(e(n).includes(s))return n;return null}getParentNode(e,t){return e.parentNode}getPreviousSibling(t,s){for(let{previousSibling:n}=t;n;n=n.previousSibling)if(e(n).includes(s))return n;return null}}class m{static isAbsolutePath(e){return null!=e&&(e.startsWith("/")||e.startsWith("instance("))}static isSelfReference(e){return"."===e||"./text()"===e||"text()"===e||""===e||null===e}static getInstanceId(e){if(e.startsWith("instance(")){const t=e.substring(e.indexOf("(")+1);return t.substring(1,t.indexOf(")")-1)}return"default"}static getPath(e){const s=t("path()",e),n=e.ownerDocument.firstElementChild.getAttribute("id");return null!==n&&"default"!==n?`#${n}${m.shortenPath(s)}`:m.shortenPath(s)}static shortenPath(e){const t=e.split("/");let s="";for(let e=2;e<t.length;e+=1){const n=t[e];if(-1!==n.indexOf("{}")){s+="/"+n.split("{}")[1]}else s+="/"+n}return s}}function g(e,t,s,n){const i={};return function(o){if(i[o])return;const r={},a=[],l=[];for(l.push({node:o,processed:!1});l.length>0;){const o=l[l.length-1],{processed:d}=o,{node:h}=o;if(d)l.pop(),a.pop(),r[h]=!1,i[h]=!0,t&&0!==e[h].length||s.push(h);else{if(i[h]){l.pop();continue}if(r[h]){if(n){l.pop();continue}a.push(h),window.dispatchEvent(new CustomEvent("compute-exception",{composed:!0,bubbles:!0,detail:{path:a,message:"cyclic graph"}}))}r[h]=!0,a.push(h);const t=e[h];for(let e=t.length-1;e>=0;e-=1)l.push({node:t[e],processed:!1});o.processed=!0}}}}function f(e){this.nodes={},this.outgoingEdges={},this.incomingEdges={},this.circular=e&&!!e.circular}f.prototype={size(){return Object.keys(this.nodes).length},addNode(e,t){this.hasNode(e)||(this.nodes[e]=2===arguments.length?t:e,this.outgoingEdges[e]=[],this.incomingEdges[e]=[])},removeNode(e){this.hasNode(e)&&(delete this.nodes[e],delete this.outgoingEdges[e],delete this.incomingEdges[e],[this.incomingEdges,this.outgoingEdges].forEach(t=>{Object.keys(t).forEach(s=>{const n=t[s].indexOf(e);n>=0&&t[s].splice(n,1)},this)}))},hasNode(e){return Object.prototype.hasOwnProperty.call(this.nodes,e)},getNodeData(e){if(this.hasNode(e))return this.nodes[e];throw new Error("Node does not exist: "+e)},setNodeData(e,t){if(!this.hasNode(e))throw new Error("Node does not exist: "+e);this.nodes[e]=t},addDependency(e,t){if(!this.hasNode(e))throw new Error("Node does not exist: "+e);if(!this.hasNode(t))throw new Error("Node does not exist: "+t);return-1===this.outgoingEdges[e].indexOf(t)&&this.outgoingEdges[e].push(t),-1===this.incomingEdges[t].indexOf(e)&&this.incomingEdges[t].push(e),!0},removeDependency(e,t){let s;this.hasNode(e)&&(s=this.outgoingEdges[e].indexOf(t),s>=0&&this.outgoingEdges[e].splice(s,1)),this.hasNode(t)&&(s=this.incomingEdges[t].indexOf(e),s>=0&&this.incomingEdges[t].splice(s,1))},clone(){const e=this,t=new f;return Object.keys(e.nodes).forEach(s=>{t.nodes[s]=e.nodes[s],t.outgoingEdges[s]=e.outgoingEdges[s].slice(0),t.incomingEdges[s]=e.incomingEdges[s].slice(0)}),t},directDependenciesOf(e){if(this.hasNode(e))return this.outgoingEdges[e].slice(0);throw new Error("Node does not exist: "+e)},directDependantsOf(e){if(this.hasNode(e))return this.incomingEdges[e].slice(0);throw new Error("Node does not exist: "+e)},dependenciesOf(e,t){if(this.hasNode(e)){const s=[];g(this.outgoingEdges,t,s,this.circular)(e);const n=s.indexOf(e);return n>=0&&s.splice(n,1),s}throw new Error("Node does not exist: "+e)},dependantsOf(e,t){if(this.hasNode(e)){const s=[];g(this.incomingEdges,t,s,this.circular)(e);const n=s.indexOf(e);return n>=0&&s.splice(n,1),s}throw new Error("Node does not exist: "+e)},overallOrder(e){const t=this,s=[],n=Object.keys(this.nodes);if(0===n.length)return s;if(!this.circular){const e=g(this.outgoingEdges,!1,[],this.circular);n.forEach(t=>{e(t)})}const i=g(this.outgoingEdges,e,s,this.circular);return n.filter(e=>0===t.incomingEdges[e].length).forEach(e=>{i(e)}),this.circular&&n.filter(e=>-1===s.indexOf(e)).forEach(e=>i(e)),s}},f.prototype.directDependentsOf=f.prototype.directDependantsOf,f.prototype.dependentsOf=f.prototype.dependantsOf;class E{static get ACTION_ELEMENTS(){return["FX-DELETE","FX-DISPATCH","FX-INSERT","FX-LOAD","FX-MESSAGE","FX-REBUILD","FX-RECALCULATE","FX-REFRESH","FX-RENEW","FX-REPLACE","FX-RESET","FX-RETAIN","FX-RETURN","FX-REVALIDATE","FX-SEND","FX-SETFOCUS","FX-SETINDEX","FX-SETVALUE","FX-TOGGLE"]}static get XFORMS_NAMESPACE_URI(){return"http://www.w3.org/2002/xforms"}static isActionElement(e){return E.ACTION_ELEMENTS.includes(e)}static get UI_ELEMENTS(){return["FX-ALERT","FX-CONTROL","FX-BUTTON","FX-CONTROL","FX-DIALOG","FX-FILENAME","FX-MEDIATYPE","FX-GROUP","FX-HINT","FX-INPUT","FX-ITEMSET","FX-LABEL","FX-OUTPUT","FX-RANGE","FX-REPEAT","FX-REPEATITEM","FX-SWITCH","FX-SECRET","FX-SELECT","FX-SUBMIT","FX-TEXTAREA","FX-TRIGGER","FX-UPLOAD"]}static isUiElement(e){E.UI_ELEMENTS.includes(e);return E.UI_ELEMENTS.includes(e)}static async refreshChildren(e){return new Promise(t=>{const{children:s}=e;s&&Array.from(s).forEach(e=>{E.isUiElement(e.nodeName)&&"function"==typeof e.refresh?e.refresh():"fx-MODEL"!==e.nodeName&&E.refreshChildren(e)}),t("done")})}static isRepeated(e){return null!==e.closest("fx-repeatitem")}static getRepeatTarget(e,t){return e.closest("fx-repeatitem").querySelector("#"+t)}}function y(e,t){let s,n;n=e.nodeType===Node.ATTRIBUTE_NODE?e.ownerElement:e.parentNode;const i=n.closest("fx-repeatitem");if(i)return i.nodeset;const o=n.closest("[ref]"),r=n.closest("fx-form").getModel();if(null!==o)s=o.nodeset;else if(m.isAbsolutePath(t)){const e=m.getInstanceId(t);s=r.getInstance(e).getDefaultContext()}else{if(null===r.getDefaultInstance())return[];s=r.getDefaultInstance().getDefaultContext()}return s}E.READONLY_DEFAULT=!1,E.REQUIRED_DEFAULT=!1,E.RELEVANT_DEFAULT=!0,E.CONSTRAINT_DEFAULT=!0,E.TYPE_DEFAULT="xs:string";const b="http://www.w3.org/2002/xforms";s({namespaceURI:b,localName:"log"},["xs:string?"],"xs:string?",(e,t)=>{const{formElement:s}=e.currentContext,n=s.querySelector(`fx-instance[id=${t}]`);if(n){return(new XMLSerializer).serializeToString(n.getDefaultContext())}return null}),s({namespaceURI:b,localName:"logtree"},["xs:string?"],"element()?",(e,t)=>{const{formElement:s}=e.currentContext,n=s.querySelector(`fx-instance[id=${t}]`);if(n){const t=document.createElement("div");t.setAttribute("class","logtree");const{formElement:s}=e.currentContext,i=s.querySelector(".logtree");i&&i.parentNode.removeChild(i),s.appendChild(function e(t,s){if(s){if(s.nodeType===Node.ELEMENT_NODE&&s.children){const n=document.createElement("details");n.setAttribute("data-path",s.nodeName);const i=document.createElement("summary");let o,r=" <"+s.nodeName;Array.from(s.attributes).forEach(e=>{r+=` ${e.nodeName}="${e.nodeValue}"`}),s.firstChild&&s.firstChild.nodeType===Node.TEXT_NODE&&""!==s.firstChild.data.trim()?(o=s.firstChild.nodeValue,r+=`>${o}</${s.nodeName}>`):r+=">",i.textContent=r,n.appendChild(i),0!==s.childElementCount?n.setAttribute("open","open"):i.setAttribute("style","list-style:none;"),t.appendChild(n),Array.from(s.children).forEach(t=>{e(n,t)})}return t}}(t,n.getDefaultContext()))}return null});const x=(e,t)=>{const{formElement:s}=e.currentContext,n=t?s.querySelector(`fx-instance[id=${t}]`):s.querySelector("fx-instance");if(n){return n.getDefaultContext()}return null};function v({prefix:e,localName:t},s){switch(t){case"log":case"logtree":case"instance":case"depends":case"boolean-from-string":return{namespaceURI:b,localName:t};default:return""===e||"fn"===e?{namespaceURI:"http://www.w3.org/2005/xpath-functions",localName:t}:"local"===e?{namespaceURI:"http://www.w3.org/2005/xquery-local-functions",localName:t}:null}}function w(e){return{xhtml:"http://www.w3.org/1999/xhtml",tei:"http://www.tei-c.org/ns/1.0"}[e]||null}function A(e,s,n,i={}){return t(e,s,null,i,"xs:anyType",{currentContext:{formElement:n},moduleImports:{xf:b},functionNameResolver:v,namespaceResolver:w})}function C(e,t,s){return i(e,t,null,{},{namespaceResolver:w,defaultFunctionNamespaceURI:b,moduleImports:{xf:b},currentContext:{formElement:s}})}function I(e,t,s){return r(e,t,null,{},{currentContext:{formElement:s},functionNameResolver:v,moduleImports:{xf:b},namespaceResolver:w})}function T(e,t,s){return o(e,t,null,{},{currentContext:{formElement:s},functionNameResolver:v,moduleImports:{xf:b},namespaceResolver:w})}function N(e,t,s,n=null){return a(e,t,n,{},{currentContext:{formElement:s},functionNameResolver:v,moduleImports:{xf:b},namespaceResolver:w})}s({namespaceURI:b,localName:"instance"},[],"item()?",e=>x(e,null)),s({namespaceURI:b,localName:"instance"},["xs:string?"],"item()?",x),s({namespaceURI:b,localName:"depends"},["node()*"],"item()?",(e,t)=>t[0]),n(`\n    module namespace xf="${b}";\n\n    declare %public function xf:boolean-from-string($str as xs:string) as xs:boolean {\n        lower-case($str) = "true" or $str = "1"\n    };\n`);class _ extends HTMLElement{constructor(){super(),this.model=this.parentNode,this.attachShadow({mode:"open"})}connectedCallback(){this.hasAttribute("src")&&(this.src=this.getAttribute("src")),this.hasAttribute("id")?this.id=this.getAttribute("id"):this.id="default",this.hasAttribute("type")?this.type=this.getAttribute("type"):this.type="xml";const e=`\n           <iron-ajax\n                id="loader"\n                url="${this.src}"\n                method="GET"\n                handle-as="text"\n                with-credentials></iron-ajax>\n        `;this.shadowRoot.innerHTML=`\n            <style>\n                \n            :host {\n                display: none;\n            }\n            :host * {\n                display:none;\n            }\n            ::slotted(*){\n                display:none;\n            }\n        \n            </style>\n            ${e}\n        `}async init(){return"xml"===this.type?await this._initXMLInstance():this._initJSONInstance(),this.dispatchEvent(new CustomEvent("instance-loaded",{composed:!0,bubbles:!0,detail:{instance:this}})),this}evalXPath(e){const t=this.parentElement.parentElement;return C(e,this.getDefaultContext(),t)}getInstanceData(){return this.instanceData}getDefaultContext(){return"xml"===this.type?this.instanceData.firstElementChild:this.instanceData}_initXMLInstance(){return new Promise((e,t)=>{if("#querystring"===this.src){const t=new URLSearchParams(location.search),s=(new DOMParser).parseFromString("<data></data>","application/xml"),n=s.firstElementChild;for(const e of t){const t=s.createElement(e[0]);t.appendChild(s.createTextNode(e[1])),n.appendChild(t)}this.instanceData=s,this.instanceData.firstElementChild.setAttribute("id",this.id),e("done")}else if(this.src){const s=this.shadowRoot.getElementById("loader");s.addEventListener("response",()=>{const t=(new DOMParser).parseFromString(s.lastResponse,"application/xml");this.instanceData=t,console.log("fx-instance data: ",this.instanceData),this.dispatchEvent(new CustomEvent("instance-loaded",{})),e(t)}),s.addEventListener("error",()=>{console.log("error while loading data from src: ",s.lastError),t()}),s.generateRequest()}else 0!==this.childNodes.length&&(this._useInlineData(),e("done"))})}_initJSONInstance(){this.instanceData=JSON.parse(this.textContent)}_useInlineData(){const e=(new DOMParser).parseFromString(this.innerHTML,"application/xml");console.log("fx-instance init id:",this.id),this.instanceData=e,console.log("fx-instance data: ",this.instanceData),this.instanceData.firstElementChild.setAttribute("id",this.id)}_handleResponse(){console.log("_handleResponse ");const e=this.shadowRoot.getElementById("loader"),t=(new DOMParser).parseFromString(e.lastResponse,"application/xml");this.instanceData=t,console.log("data: ",this.instanceData)}_handleError(){const e=this.shadowRoot.getElementById("loader");console.log("_handleResponse ",e.lastError)}}customElements.define("fx-instance",_);class R{constructor(e,t,s,n,i,o,r,a,l){this.path=e,this.ref=t,this.constraint=o,this.readonly=s,this.relevant=n,this.required=i,this.type=r,this.node=a,this.bind=l,this.changed=!1,this.alerts=[]}get value(){return this.node.nodeType?this.node.nodeType===Node.ATTRIBUTE_NODE?this.node.nodeValue:this.node.textContent:this.node}set value(e){console.log("modelitem.setvalue oldVal",this.value),console.log("modelitem.setvalue newVal",e),this.node.nodeType===Node.ATTRIBUTE_NODE?this.node.nodeValue=e:this.node.textContent=e}addAlert(e){this.alerts.push(e)}cleanAlerts(){this.alerts=[]}}class M extends HTMLElement{constructor(){super(),this.instances=[],this.modelItems=[],this.defaultContext={},this.mainGraph=new f(!1),this.inited=!1,this.modelConstructed=!1,this.attachShadow({mode:"open"})}get formElement(){return this.parentElement}connectedCallback(){this.shadowRoot.innerHTML="\n            <slot></slot>\n        ",this.addEventListener("model-construct-done",e=>{this.modelConstructed=!0,console.log("model-construct-done fired ",e.detail.model.instances)})}static lazyCreateModelItem(e,t,s){let n,i={};if(null===s)return null;i=s.nodeType===s.TEXT_NODE?s.parentNode:s,s.nodeType?n=m.getPath(s):(n=null,i=s);const o=new R(n,t,E.READONLY_DEFAULT,E.RELEVANT_DEFAULT,E.REQUIRED_DEFAULT,E.CONSTRAINT_DEFAULT,E.TYPE_DEFAULT,i,this);return e.registerModelItem(o),o}modelConstruct(){console.log("### <<<<< dispatching model-construct >>>>>"),this.dispatchEvent(new CustomEvent("model-construct",{detail:this}));const e=this.querySelectorAll("fx-instance");if(e.length>0){console.group("init instances");const t=[];e.forEach(e=>{t.push(e.init())}),Promise.all(t).then(()=>{this.instances=Array.from(e),console.log("_modelConstruct this.instances ",this.instances),this.updateModel(),this.inited=!0,console.log("### <<<<< dispatching model-construct-done >>>>>"),this.dispatchEvent(new CustomEvent("model-construct-done",{composed:!0,bubbles:!0,detail:{model:this}}))}),console.groupEnd()}else this.dispatchEvent(new CustomEvent("model-construct-done",{composed:!0,bubbles:!0,detail:{model:this}}));this.inited=!0}registerModelItem(e){this.modelItems.push(e)}updateModel(){this.rebuild(),this.recalculate(),this.revalidate()}rebuild(){console.group("### rebuild"),this.modelItems=[];this.querySelectorAll("fx-model > fx-bind").forEach(e=>{e.init(this)}),console.log("rebuild mainGraph calc order",this.mainGraph.overallOrder()),console.groupEnd()}recalculate(){console.group("### recalculate"),console.log("recalculate instances ",this.instances);this.mainGraph.overallOrder().forEach(e=>{const t=this.mainGraph.getNodeData(e),s=this.getModelItem(t);if(s&&e.includes(":")){const t=e.split(":")[1];if(t)if("calculate"===t){const e=A(s.bind[t],s.node,this);s.value=e}else if("constraint"!==t&&"type"!==t){const e=s.bind[t];if(e){const n=T(e,s.node,this);s[t]=n}}}}),console.log(`recalculate finished with modelItems ${this.modelItems.length} item(s)`,this.modelItems),console.groupEnd()}revalidate(){console.group("### revalidate");let e=!0;return this.modelItems.forEach(t=>{const{bind:s}=t;if(s&&"function"==typeof s.hasAttribute&&s.hasAttribute("constraint")){const n=s.getAttribute("constraint");if(n){const i=T(n,t.node,this);if(console.log("modelItem validity computed: ",i),t.constraint=i,i||(e=!1),!this.modelConstructed){const e=s.getAlert();e&&t.addAlert(e)}}}}),console.log("modelItems after revalidate: ",this.modelItems),console.groupEnd(),e}getModelItem(e){return this.modelItems.find(t=>t.node===e)}getDefaultContext(){return this.instances[0].getDefaultContext()}getDefaultInstance(){return this.instances[0]}getDefaultInstanceData(){return console.log("default instance data ",this.instances[0].instanceData),this.instances[0].instanceData}getInstance(e){return Array.from(this.instances).find(t=>t.id===e)}evalBinding(e){return this.instances[0].evalXPath(e)}}customElements.define("fx-model",M);const L=e=>class extends e{static get properties(){return{model:{type:Object},ref:{type:String},modelItem:{type:Object}}}constructor(){super(),this.model=null,this.modelItem={},this.ref=this.hasAttribute("ref")?this.getAttribute("ref"):""}getModel(){if(this.model)return this.model;return this.getOwnerForm().querySelector("fx-model")}getOwnerForm(){let e=this;for(;e&&e.parentNode;){if("FX-FORM"===e.nodeName.toUpperCase())return e;e=e.parentNode instanceof DocumentFragment?e.parentNode.host:e.parentNode}return e}evalInContext(){const e=y(this,this.ref);if(""===this.ref)this.nodeset=e;else if(Array.isArray(e))e.forEach(t=>{if(m.isSelfReference(this.ref))this.nodeset=e;else{const e=C(this.ref,t,null);this.nodeset.push(e)}});else{const t=this.closest("fx-form");e.nodeType?this.nodeset=C(this.ref,e,t):this.nodeset=A(this.ref,e,t)}}isNotBound(){return!this.hasAttribute("ref")}isBound(){return this.hasAttribute("ref")}getBindingExpr(){if(this.hasAttribute("ref"))return this.getAttribute("ref");const e=this.parentNode.closest("[ref]");return e?e.getAttribute("ref"):"instance()"}_getParentBindingElement(e){if(e.parentNode.host){const{host:t}=e.parentNode;if(t.hasAttribute("ref"))return t}else if(e.parentNode){if(e.parentNode.hasAttribute("ref"))return this.parentNode;this._getParentBindingElement(this.parentNode)}return null}getModelItem(){const e=this.getModel().getModelItem(this.nodeset);e&&(this.modelItem=e);let t;if(this.closest("fx-repeatitem")){const{index:e}=this.closest("fx-repeatitem");t=Array.isArray(this.nodeset)?this.getModel().getModelItem(this.nodeset[e-1]):this.getModel().getModelItem(this.nodeset)}else t=this.getModel().getModelItem(this.nodeset);return t||M.lazyCreateModelItem(this.getModel(),this.ref,this.nodeset)}getInScopeContext(){let e;const t=this.parentNode.closest("fx-repeatitem");if(t)return t.nodeset;const s=this.parentNode.closest("[ref]");if(null!==s)e=s.nodeset;else if(m.isAbsolutePath(this.ref)){const t=m.getInstanceId(this.ref);e=this.getModel().getInstance(t).getDefaultContext()}else{if(null===this.getModel().getDefaultInstance())return[];e=this.getModel().getDefaultInstance().getDefaultContext()}return e}};class S extends(L(HTMLElement)){constructor(){super(),this.nodeset=[],this.model={},this.contextNode={},this.inited=!1}connectedCallback(){this.ref=this.getAttribute("ref"),this.readonly=this.getAttribute("readonly"),this.required=this.getAttribute("required"),this.relevant=this.getAttribute("relevant"),this.type=this.hasAttribute("type")?this.getAttribute("type"):S.TYPE_DEFAULT,this.calculate=this.getAttribute("calculate")}init(e){this.model=e,console.log("init binding ",this),this.instanceId=this._getInstanceId(),this.bindType=this.getModel().getInstance(this.instanceId).type,"xml"===this.bindType&&(this._evalInContext(),this._buildBindGraph(),this._createModelItems()),this._processChildren(e)}_buildBindGraph(){"xml"===this.bindType&&this.nodeset.forEach(e=>{const t=m.getPath(e);this.calculate&&(this.model.mainGraph.addNode(t+":calculate",e),this.model.mainGraph.addNode(t,e),this.model.mainGraph.addDependency(t,t+":calculate"));const s=this._getReferencesForProperty(this.calculate,e);0!==s.length&&this._addDependencies(s,e,t,"calculate");const n=this._getReferencesForProperty(this.readonly,e);0!==n.length?this._addDependencies(n,e,t,"readonly"):this.readonly&&this.model.mainGraph.addNode(t+":readonly",e);const i=this._getReferencesForProperty(this.required,e);0!==i.length?this._addDependencies(i,e,t,"required"):this.required&&this.model.mainGraph.addNode(t+":required",e);const o=this._getReferencesForProperty(this.relevant,e);0!==o.length?this._addDependencies(o,e,t,"relevant"):this.relevant&&this.model.mainGraph.addNode(t+":relevant",e);const r=this._getReferencesForProperty(this.constraint,e);0!==r.length?this._addDependencies(r,e,t,"constraint"):this.constraint&&this.model.mainGraph.addNode(t+":constraint",e)})}_addNode(e,t){this.model.mainGraph.hasNode(e)||this.model.mainGraph.addNode(e,{node:t})}_addDependencies(e,t,s,n){const i=`${s}:${n}`;0!==e.length?(this.model.mainGraph.hasNode(i)||this.model.mainGraph.addNode(i,t),e.forEach(e=>{const t=m.getPath(e);this.model.mainGraph.hasNode(t)||this.model.mainGraph.addNode(t,e),this.model.mainGraph.addDependency(i,t)})):this.model.mainGraph.addNode(i,t)}_processChildren(e){const t=this.querySelectorAll(":scope > fx-bind");Array.from(t).forEach(t=>{t.init(e)})}getAlert(){if(this.hasAttribute("alert"))return this.getAttribute("alert");const e=this.querySelector("fx-alert");return e?e.innerHTML:null}_evalInContext(){const e=this.getInScopeContext();if(this.nodeset=[],""===this.ref||null===this.ref)this.nodeset=e;else if(Array.isArray(e))e.forEach(t=>{if(m.isSelfReference(this.ref))this.nodeset=e;else if(this.ref){I(this.ref,t,this.getOwnerForm()).forEach(e=>{this.nodeset.push(e)})}});else{for(let e=this;e&&"fx-form"!==e.localName;e=e.parentNode);"xml"===this.getModel().getInstance(this.instanceId).type?this.nodeset=I(this.ref,e,this.getOwnerForm()):this.nodeset=this.ref}}_createModelItems(){Array.isArray(this.nodeset)?Array.from(this.nodeset).forEach(e=>{this._createModelItem(e)}):this._createModelItem(this.nodeset)}static lazyCreateModelitems(e,t,s){Array.isArray(s)?Array.from(s).forEach(s=>{S.lazyCreateModelItem(e,t,s)}):S.lazyCreateModelItem(e,t,s)}_createModelItem(e){if(m.isSelfReference(this.ref)){const e=this.parentElement.closest("fx-bind[ref]");return console.log("parent bound element ",e),void(e?e.required=this.required:console.error("no parent bound element"))}let t={};t=e.nodeType===e.TEXT_NODE?e.parentNode:e;const s=m.getPath(e),n=new R(s,this.getBindingExpr(),S.READONLY_DEFAULT,S.RELEVANT_DEFAULT,S.REQUIRED_DEFAULT,S.CONSTRAINT_DEFAULT,this.type,t,this);this.getModel().registerModelItem(n)}_getReferencesForProperty(e){if(e){const t=new Set,s=new p(e=>t.add(e));return this.nodeset.forEach(t=>{N(e,t,this.getOwnerForm(),s)}),Array.from(t.values())}return[]}_initBooleanModelItemProperty(e,t){return T(this[e],t,this)}static shortenPath(e){const t=e.split("/");let s="";for(let e=2;e<t.length;e+=1){const n=t[e];if(-1!==n.indexOf("{}")){s+="/"+n.split("{}")[1]}else s+="/"+n}return s}_getInstanceId(){const e=this.getBindingExpr();return e.startsWith("instance(")?(this.instanceId=m.getInstanceId(e),this.instanceId):this.instanceId?this.instanceId:"default"}}S.READONLY_DEFAULT=!1,S.REQUIRED_DEFAULT=!1,S.RELEVANT_DEFAULT=!0,S.CONSTRAINT_DEFAULT=!0,S.TYPE_DEFAULT="xs:string",customElements.define("fx-bind",S);class D extends HTMLElement{static get properties(){return{model:{type:Object},ready:{type:Boolean}}}constructor(){super(),this.model={},this.addEventListener("model-construct-done",this._handleModelConstructDone),this.addEventListener("message",this._displayMessage),this.addEventListener("error",this._displayError),window.addEventListener("compute-exception",e=>{console.error("circular dependency: ",e)}),this.ready=!1;this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n            <style>\n                \n            :host {\n                display: block;\n                height:auto;\n                padding:var(--model-element-padding);\n                font-family:Roboto, sans-serif;\n                color:var(--paper-grey-900);\n            }\n            :host ::slotted(fx-model){\n                display:none;\n            }\n            #modalMessage .dialogActions{\n                text-align:center;\n            }\n        \n            </style>\n            \n           <slot></slot>\n           <paper-dialog id="modalMessage" modal="true">\n                <div id="messageContent"></div>\n                <div class="dialogActions">\n                    <paper-button dialog-dismiss autofocus>Close</paper-button>\n                </div>\n           </paper-dialog>\n        \n        '}connectedCallback(){this.shadowRoot.querySelector("slot").addEventListener("slotchange",e=>{let t=e.target.assignedElements().find(e=>"FX-MODEL"===e.nodeName.toUpperCase());if(!t){const e=document.createElement("FX-model");this.appendChild(e),t=e}t.inited||(console.log("########## FORE: kick off processing... ##########"),t.modelConstruct()),this.model=t})}evaluateToNodes(e,t){return I(e,t,this)}disconnectedCallback(){}async refresh(){console.group("### refresh"),E.refreshChildren(this),this._updateTemplateExpressions(),console.groupEnd(),console.log("### <<<<< dispatching refresh-done - end of UI update cycle >>>>>"),this.dispatchEvent(new CustomEvent("refresh-done"))}_updateTemplateExpressions(){const e=I("(descendant-or-self::*/(text(), @*))[matches(.,'\\{.*\\}')] except descendant-or-self::xhtml:fx-model/descendant-or-self::node()/(., @*)",this,null);console.log("template expressions found ",e),this.storedTemplateExpressions||(this.storedTemplateExpressions=[]),Array.from(e).forEach(e=>{const t=this._getTemplateExpression(e);this.storedTemplateExpressions.push({expr:t,node:e})}),this.storedTemplateExpressions.forEach(e=>{this._processTemplateExpression(e)}),console.log("stored template expressions ",this.storedTemplateExpressions)}_processTemplateExpression(e){console.log("processing template expression ",e);const{expr:t}=e,{node:s}=e;!function(e,t,s){const n=e.match(/{[^}]*}/g);n&&n.forEach(n=>{console.log("match ",n);const i=n.substring(1,n.length-1),o=N(i,y(t,i),s),r=e.replaceAll(n,o);if(console.log("result of replacing ",r),t.nodeType===Node.ATTRIBUTE_NODE){t.ownerElement.setAttribute(t.nodeName,r)}else t.nodeType===Node.TEXT_NODE&&(t.textContent=r)})}(t,s,this)}_getTemplateExpression(e){return e.nodeType===Node.ATTRIBUTE_NODE?e.value:e.nodeType===Node.TEXT_NODE?e.textContent:null}_refreshChildren(){this.querySelectorAll("*").forEach(e=>{E.isUiElement(e.nodeName)&&"function"==typeof e.refresh&&e.refresh()})}_handleModelConstructDone(){this._initUI()}async _lazyCreateInstance(){const e=this.querySelector("fx-model");if(0===e.instances.length){console.log("### lazy creation of instance");const t=document.createElement("fx-instance");e.appendChild(t);const s=document.implementation.createDocument(null,"data",null);this._generateInstance(this,s.firstElementChild),t.instanceData=s,e.instances.push(t),console.log("generatedInstance ",this.getModel().getDefaultInstanceData())}}_generateInstance(e,t){if(e.hasAttribute("ref")){const s=e.getAttribute("ref");if(s.includes("/")){console.log("complex path to create ",s);s.split("/").forEach(s=>{console.log("step ",s),t=this._generateNode(t,s,e)})}else t=this._generateNode(t,s,e)}if(e.hasChildNodes()){const s=e.children;for(let e=0;e<s.length;e+=1)this._generateInstance(s[e],t)}return t}_generateNode(e,t,s){const n=e.ownerDocument.createElement(t);return 0===s.children.length&&(n.textContent=s.textContent),e.appendChild(n),e=n}async _initUI(){console.log("### _initUI()"),await this._lazyCreateInstance(),await this.refresh(),this.ready=!0,console.log("### <<<<< dispatching ready >>>>>"),console.log("########## modelItems: ",this.getModel().modelItems),console.log("########## FORE: form fully initialized... ##########"),this.dispatchEvent(new CustomEvent("ready",{}))}getModel(){return this.querySelector("fx-model")}_displayMessage(e){const{level:t}=e.detail,s=e.detail.message;this._showMessage(t,s)}_displayError(e){const t=e.detail.message;this._showMessage("modal",t)}_showMessage(e,t){if("modal"===e)this.shadowRoot.getElementById("messageContent").innerText=t,this.shadowRoot.getElementById("modalMessage").open();else if("modeless"===e){const e=document.createElement("vaadin-notification");e.duration=0,e.setAttribute("theme","error"),e.renderer=s=>{s.textContent=t;const n=window.document.createElement("paper-icon-button");n.setAttribute("icon","close"),n.addEventListener("click",()=>{e.close()}),s.appendChild(n)},this.appendChild(e),e.open()}else{const e=document.createElement("vaadin-notification");e.renderer=e=>{e.textContent=t},this.appendChild(e),e.open()}}}customElements.define("fx-form",D);class F extends(L(HTMLElement)){constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){if(this.style.display="none",this.model=this.parentNode,!this.hasAttribute("id"))throw new Error("id is required");if(this.id=this.getAttribute("id"),this.instance=this.hasAttribute("instance")?this.getAttribute("instance"):null,this.method=this.hasAttribute("method")?this.getAttribute("method"):"get",this.nonrelevant=this.hasAttribute("nonrelevant")?this.getAttribute("nonrelevant"):"remove",this.replace=this.hasAttribute("replace")?this.getAttribute("replace"):"all",!this.hasAttribute("url"))throw new Error("url is required for submission: "+this.id);this.url=this.getAttribute("url"),this.targetref=this.hasAttribute("targetref")?this.getAttribute("targetref"):null,this.mediatype=this.hasAttribute("mediatype")?this.getAttribute("mediatype"):"application/xml",this.validate=this.getAttribute("validate")?this.getAttribute("validate"):"true",this.shadowRoot.innerHTML=this.renderHTML(),this.addEventListener("submit",()=>this._submit())}renderHTML(){return"\n      <slot></slot>\n    "}submit(){this.dispatchEvent(new CustomEvent("submit",{composed:!0,bubbles:!0,detail:{}}))}_submit(){console.log("submitting...."),this.evalInContext();const e=this.getModel();if(e.recalculate(),this.validate){if(!e.revalidate())return}this._serializeAndSend()}_evaluateAttributeTemplateExpression(e,t){const s=e.match(/{[^}]*}/g);return s&&s.forEach(s=>{console.log("match ",s);const n=s.substring(1,s.length-1),i=N(n,y(t,n),this.getOwnerForm()),o=e.replaceAll(s,i);console.log("result of replacing ",o),e=o}),e}async _serializeAndSend(){const e=this._evaluateAttributeTemplateExpression(this.url,this);let t=(new XMLSerializer).serializeToString(this.nodeset);"get"===this.method.toLowerCase()&&(t=void 0);const s=await fetch(e,{method:this.method,mode:"cors",credentials:"same-origin",headers:{"Content-type":"application/xml; charset=UTF-8"},body:t});s.ok||this.dispatchEvent(new CustomEvent("submit-error",{composed:!0,bubbles:!0,detail:{message:"Error while submitting "+this.id}}));const n=s.headers.get("content-type").toLowerCase();if(n.startsWith("text/plain")||n.startsWith("text/html")){const e=await s.text();this._handleResponse(e)}else if(n.startsWith("application/json")){const e=await s.json();this._handleResponse(e)}else if(n.startsWith("application/xml")){const e=await s.text(),t=(new DOMParser).parseFromString(e,"application/xml");this._handleResponse(t)}else{const e=await s.blob();this._handleResponse(e)}}_getUrlExpr(){return this.storedTemplateExpressions.find(e=>"url"===e.node.nodeName)}_getTargetInstance(){let e;if(e=this.instance?this.model.getInstance(this.instance):this.model.getInstance("default"),!e)throw new Error("target instance not found: "+e);return e}_handleResponse(e){if(console.log("_handleResponse ",e),"instance"===this.replace){const t=this._getTargetInstance();if(!t)throw new Error("target instance not found: "+t);{const s=e;t.instanceData=s,console.log("### replaced instance ",t.instanceData),this.model.updateModel(),this.getOwnerForm().refresh()}}if("all"===this.replace&&(document.getElementsByTagName("html")[0].innerHTML=e),"target"===this.replace){const t=this.getAttribute("target");document.querySelector(t).innerHTML=e}"redirect"===this.replace&&(window.location.href=e),this.dispatchEvent(new CustomEvent("submit-done",{composed:!0,bubbles:!0,detail:{}}))}_handleError(){console.log("ERRRORRRRR"),this.dispatchEvent(new CustomEvent("submit-error",{composed:!0,bubbles:!0,detail:{}}))}}customElements.define("fx-submission",F);class O extends(L(HTMLElement)){constructor(){super(),this.value="",this.display=this.style.display,this.required=!1,this.readonly=!1,this.widget=null}getWidget(){throw new Error("You have to implement the method updateWidgetValue!")}async refresh(){console.log("### AbstractControl.refresh on : ",this);const e=this.value;if(!this.isNotBound()&&(this.evalInContext(),this.isBound())){if(null===this.nodeset)return void(this.style.display="none");if(this.modelItem=this.getModelItem(),this.modelItem instanceof R){if(this.value=this.modelItem.value,await this.updateWidgetValue(),this.handleModelItemProperties(),!this.getOwnerForm().ready)return;e!==this.value&&this.dispatchEvent(new CustomEvent("value-changed",{composed:!0,bubbles:!0,detail:{path:this.modelItem.path}}))}}}async updateWidgetValue(){throw new Error("You have to implement the method updateWidgetValue!")}handleModelItemProperties(){this.handleRequired(),this.handleReadonly(),this.handleValid(),this.handleRelevant()}_getForm(){return this.getModel().parentNode}_dispatchEvent(e){this.getOwnerForm().ready&&this.dispatchEvent(new CustomEvent(e,{}))}handleRequired(){this.widget=this.getWidget(),this.isRequired()!==this.modelItem.required&&(this.modelItem.required?(this.widget.setAttribute("required","required"),this.classList.add("required"),this._dispatchEvent("required")):(this.widget.removeAttribute("required"),this.required=!1,this.classList.toggle("required"),this.dispatchEvent(new CustomEvent("optional",{}))))}handleReadonly(){this.isReadonly()!==this.modelItem.readonly&&(this.modelItem.readonly&&(this.widget.setAttribute("readonly","readonly"),this.classList.toggle("readonly"),this._dispatchEvent("readonly")),this.modelItem.readonly||(this.widget.removeAttribute("readonly"),this.classList.toggle("readonly"),this.dispatchEvent(new CustomEvent("readwrite",{}))))}handleValid(){const e=this.querySelector("fx-alert");if(this.isValid()!==this.modelItem.constraint)if(this.modelItem.constraint)this.classList.remove("invalid"),e.style.display="none",this.dispatchEvent(new CustomEvent("valid",{}));else{if(this.classList.add("invalid"),e&&(e.style.display="block"),0!==this.modelItem.alerts.length){const{alerts:e}=this.modelItem;console.log("alerts from bind: ",e);this.querySelector("fx-alert")||e.forEach(e=>{const t=document.createElement("fx-alert");t.innerHTML=e,this.appendChild(t),t.style.display="block"})}this._dispatchEvent("invalid")}}handleRelevant(){this.isEnabled()!==this.modelItem.relevant&&(this.modelItem.relevant?(this.dispatchEvent(new CustomEvent("relevant",{})),this._fadeIn(this,this.display)):(this._dispatchEvent("nonrelevant"),this._fadeOut(this)))}isRequired(){return!!this.widget.hasAttribute("required")}isValid(){return!this.classList.contains("invalid")}isReadonly(){return!!this.widget.hasAttribute("readonly")}isEnabled(){return"none"!==this.style.display}_fadeOut(e){e.style.opacity=1,function t(){(e.style.opacity-=.1)<0?e.style.display="none":requestAnimationFrame(t)}()}_fadeIn(e,t){e.style.opacity=0,e.style.display=t||"block",function t(){let s=parseFloat(e.style.opacity);(s+=.1)>1||(e.style.opacity=s,requestAnimationFrame(t))}()}}window.customElements.define("fx-abstract-control",O);customElements.define("fx-alert",class extends O{static get styles(){return l`:host{display:block;height:auto;font-size:.8em;font-weight:400;color:red;display:none}`}constructor(){super(),this.style.display="none"}static get properties(){return{...super.properties}}render(){return d`<slot></slot>`}});window.customElements.define("fx-control",class extends O{constructor(){super(),this.inited=!1,this.attachShadow({mode:"open"})}connectedCallback(){this.updateEvent=this.hasAttribute("update-event")?this.getAttribute("update-event"):"blur",this.valueProp=this.hasAttribute("value-prop")?this.getAttribute("value-prop"):"value",this.label=this.hasAttribute("label")?this.getAttribute("label"):null;this.shadowRoot.innerHTML=`\n            <style>\n                \n            :host{\n                display:inline-block;\n            }\n        \n            </style>\n            ${this.renderHTML(this.ref)}\n        `,this.widget=this.getWidget(),console.log("widget ",this.widget),this.widget.addEventListener(this.updateEvent,()=>{console.log("eventlistener ",this.updateEvent),this.setValue(this.widget[this.valueProp])})}setValue(e){const t=this.getModelItem(),s=this.shadowRoot.getElementById("setvalue");s.setValue(t,e),s.actionPerformed()}renderHTML(e){return`\n            ${this.label?""+this.label:""}\n            <slot></slot>\n            <fx-setvalue id="setvalue" ref="${e}"></fx-setvalue>\n        `}getWidget(){let e=this.querySelector(".widget");if(e||(e=this.querySelector("input")),!e){const e=document.createElement("input");return e.classList.add("widget"),e.setAttribute("type","text"),this.appendChild(e),e}return e}async updateWidgetValue(){if("checked"===this.valueProp)"true"===this.value?this.widget.checked=!0:this.widget.checked=!1;else{let{widget:e}=this;e||(e=this),e.value=this.value}}async refresh(){if(super.refresh(),this.widget.hasAttribute("ref")){const e=this.widget.querySelector("template"),t=this.widget.getAttribute("ref"),s=this.getInScopeContext(),n=this.closest("fx-form"),i=I(t,s,n),{children:o}=this.widget;Array.from(o).forEach(e=>{"template"!==e.nodeName.toLowerCase()&&e.parentNode.removeChild(e)}),Array.from(i).forEach(t=>{const s=e.content.firstElementChild.cloneNode(!0),i=document.importNode(s,!0);this.widget.appendChild(i);const o=this._getValueAttribute(i),r=o.value,a=A(r.substring(1,r.length-1),t,n);o.value=a,this.value===a&&i.setAttribute("selected","selected");const l=i.textContent,d=l.substring(1,l.length-1);console.log("label Expr ",d);const h=A(d,t,n);i.textContent=h.textContent})}}_getValueAttribute(e){let t;return Array.from(e.attributes).forEach(e=>{-1!==e.value.indexOf("{")&&(t=e)}),t}});class k extends(L(HTMLElement)){constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.shadowRoot.innerHTML="\n            <style>\n                \n        :host {\n            display: block;\n        }\n    \n            </style>\n            \n      <slot></slot>\n    \n    "}refresh(){console.log("### FxContainer.refresh on : ",this),this.isBound()&&(this.evalInContext(),this.modelItem=this.getModelItem(),this.value=this.modelItem.value),this._getForm().ready&&this.handleModelItemProperties(),E.refreshChildren(this)}handleModelItemProperties(){this.handleReadonly(),this.handleRelevant()}_getForm(){return this.getModel().parentNode}handleReadonly(){this.isReadonly()!==this.modelItem.readonly&&(this.modelItem.readonly&&(this.setAttribute("readonly","readonly"),this.dispatchEvent(new CustomEvent("readonly",{}))),this.modelItem.readonly||(this.removeAttribute("readonly"),this.dispatchEvent(new CustomEvent("readwrite",{}))))}handleRelevant(){this.isEnabled()!==this.modelItem.enabled&&(this.modelItem.enabled?this.dispatchEvent(new CustomEvent("enabled",{})):this.dispatchEvent(new CustomEvent("disabled",{})))}isReadonly(){return!!this.hasAttribute("readonly")}isEnabled(){return"none"!==this.style.display}}window.customElements.define("fx-container",k);window.customElements.define("fx-group",class extends k{static get properties(){return{...super.properties,collapse:{type:Boolean,reflect:!0}}}constructor(){super(),this.collapse=!1}render(){return d`<slot></slot>`}handleModelItemProperties(){this.handleRelevant()}initializeChildren(e){const t=Array.from(e.children);console.log("_initializeChildren ",t),t.forEach(e=>{if(console.log("child ",e),E.isUiElement(e.nodeName))e.init(this.model);else if(0!==e.children.length){Array.from(e.children).forEach(e=>{this.initializeChildren(e)})}}),console.groupEnd()}});customElements.define("fx-hint",class extends O{static get styles(){return l`:host{display:block;height:auto;font-size:.8em;font-weight:400;font-style:italic}`}static get properties(){return{...super.properties}}render(){return d`<slot></slot>`}});customElements.define("fx-items",class extends O{static get styles(){return l`:host{display:block;height:auto;font-size:.8em;font-weight:400;font-style:italic}`}static get properties(){return{...super.properties}}render(){return d`<slot></slot>`}});customElements.define("fx-output",class extends O{static get properties(){return{...super.properties}}constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){console.log("connectedCallback output",this.shadowRoot);const e=`\n            <slot name="label"></slot>\n            <slot></slot>\n            <span id="widget">${this.value}</span>\n        `;this.shadowRoot.innerHTML=`\n            <style>\n                \n          :host {\n            display: inline-block;\n          }\n          #widget {\n            display: inline-block;\n          }\n          [name='label'] {\n            display: inline;\n          }\n        \n            </style>\n            ${e}\n        `,this.widget=this.getWidget(),console.log("widget ",this.widget),this.addEventListener("slotchange",e=>{console.log("slotchange ",e)})}getWidget(){const e=this.querySelector(".widget");return e||this.shadowRoot.querySelector("#widget")}async updateWidgetValue(){this.widget.innerHTML=this.value}isReadonly(){return this.readonly=!0,this.readonly}});customElements.define("fx-code",class extends O{static get properties(){return{...super.properties}}constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){console.log("connectedCallback output",this.shadowRoot);const e=`\n            <wc-codemirror class="widget">${this.value}</wc-codemirror>\n        `;this.shadowRoot.innerHTML=`\n            <style>\n                \n          :host {\n            display: block;\n            width:100%;\n          }\n          #widget {\n            display: inline-block;\n          }\n          [name='label'] {\n            display: inline;\n          }\n        \n            </style>\n            ${e}\n        `,this.widget=this.getWidget(),console.log("widget ",this.widget),this.addEventListener("slotchange",e=>{console.log("slotchange ",e)})}getWidget(){const e=this.querySelector(".widget");return e||this.shadowRoot.querySelector("#widget")}async updateWidgetValue(){this.widget.setValue(this.modelItem.node.outerHTML),this.widget.editor.refresh()}isReadonly(){return this.readonly=!0,this.readonly}});class U extends(L(HTMLElement)){static get properties(){return{inited:{type:Boolean}}}constructor(){super(),this.inited=!1,this.addEventListener("click",this._dispatchIndexChange),this.attachShadow({mode:"open"})}_dispatchIndexChange(){this.parentNode&&this.parentNode.dispatchEvent(new CustomEvent("item-changed",{composed:!0,bubbles:!0,detail:{item:this}}))}connectedCallback(){this.shadowRoot.innerHTML="\n            \n           <slot></slot>\n        \n        "}disconnectedCallback(){this.removeEventListener("click",this._dispatchIndexChange())}init(){this.inited=!0}getModelItem(){return super.getModelItem(),this.getModelItem()[this.index]}refresh(){E.refreshChildren(this)}}window.customElements.define("fx-repeatitem",U);class q extends(L(HTMLElement)){static get properties(){return{...super.properties,index:{type:Number},ref:{type:String},template:{type:Object},focusOnCreate:{type:String},initDone:{type:Boolean},repeatIndex:{type:Number},nodeset:{type:Array}}}constructor(){super(),this.ref="",this.dataTemplate=[],this.focusOnCreate="",this.initDone=!1,this.repeatIndex=1,this.nodeset=[],this.inited=!1,this.index=1,this.repeatSize=0,this.attachShadow({mode:"open"})}get repeatSize(){return this.querySelectorAll(":scope > fx-repeatitem").length}set repeatSize(e){this.size=e}setIndex(e){this.index=e;const t=this.querySelectorAll(":scope > fx-repeatitem");this.applyIndex(t[this.index-1])}applyIndex(e){this._removeIndexMarker(),e&&e.setAttribute("repeat-index","")}get index(){return this.getAttribute("index")}set index(e){this.setAttribute("index",e)}connectedCallback(){this.ref=this.getAttribute("ref"),this.addEventListener("item-changed",e=>{console.log("handle index event ",e);const{item:t}=e.detail,s=Array.from(this.children).indexOf(t);this.applyIndex(this.children[s]),this.index=s+1}),this.addEventListener("index-changed",e=>{e.stopPropagation(),console.log("handle index event ",e);const{index:t}=e.detail;this.index=t,this.applyIndex(this.children[t-1])});this.shadowRoot.innerHTML="\n            <style>\n                \n            :host {\n                // display: none;\n            }\n            ::slotted(*){\n                // display:none;\n            }\n            .fade-out-bottom {\n                -webkit-animation: fade-out-bottom 0.7s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n                animation: fade-out-bottom 0.7s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n            }\n            .fade-out-bottom {\n                -webkit-animation: fade-out-bottom 0.7s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n                animation: fade-out-bottom 0.7s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n            }\n        \n            </style>\n            \n          <slot></slot>\n        \n        "}init(){this._evalNodeset(),this._initTemplate(),this._initRepeatItems(),this.setAttribute("index",this.index),this.inited=!0}_evalNodeset(){const e=y(this,this.ref),t=A(this.ref,e,this.getOwnerForm());if(null!==t){if("object"==typeof t){if("nodeType"in t)return void(this.nodeset=[t]);if(Array.isArray(t)&&t.every(e=>"object"==typeof e))return void(this.nodeset=t)}throw new Error("Unexpected result of repeat nodeset: "+t)}this.nodeset=[]}async refresh(){console.group("fx-repeat.refresh on",this.id),this.inited||this.init(),this._evalNodeset();const e=this.querySelectorAll(":scope > fx-repeatitem"),t=e.length;let s=1;Array.isArray(this.nodeset)&&(s=this.nodeset.length);const n=s,i=[];if(n<t)for(let s=t;s>n;s-=1){const t=e[s-1];this._fadeOut(t)}if(n>t)for(let e=t+1;e<=n;e+=1){const t=document.createElement("fx-repeatitem"),s=this._clone();t.style.opacity="0",t.appendChild(s),this._fadeIn(t),t.nodeset=this.nodeset[e-1],t.index=e,this.appendChild(t),i.push(t)}i.length>0&&i.forEach(e=>{e.refresh()}),this.inited||E.refreshChildren(this),n===t&&E.refreshChildren(this),console.groupEnd()}_fadeIn(e){e.style.opacity=0,function t(){let s=parseFloat(e.style.opacity);s+=.1,s>1||(e.style.opacity=s,requestAnimationFrame(t))}()}_fadeOut(e){e.classList.add("fade-out-bottom")}_initTemplate(){const e=this.shadowRoot.querySelector("template");console.log("shadowtempl ",e),this.template=this.firstElementChild,console.log("### init template for repeat ",this.id,this.template),null===this.template&&this.dispatchEvent(new CustomEvent("no-template-error",{composed:!0,bubbles:!0,detail:{message:"no template found for repeat:"+this.id}})),this.shadowRoot.appendChild(this.template)}_initRepeatItems(){this.textContent="",this.nodeset.forEach((e,t)=>{const s=document.createElement("fx-repeatitem");s.nodeset=this.nodeset[t],s.index=t+1;const n=this._clone();s.appendChild(n),this.appendChild(s),1===s.index&&this.applyIndex(s)})}_clone(){this.template=this.shadowRoot.querySelector("template");const e=this.template.content.cloneNode(!0);return document.importNode(e,!0)}_removeIndexMarker(){Array.from(this.children).forEach(e=>{e.removeAttribute("repeat-index")})}}window.customElements.define("fx-repeat",q);class P extends(L(k)){connectedCallback(){super.connectedCallback(),this.hasAttribute("ref")&&(this.ref=this.getAttribute("ref"));this.shadowRoot.querySelector("slot").addEventListener("slotchange",e=>{e.target.assignedElements()})}refresh(){this.ref&&(this.evalInContext(),this.modelItem=this.getModelItem(),this.value=this.modelItem.value);const e=this.querySelectorAll("fx-case");this.isBound()?Array.from(e).forEach(e=>{e.getAttribute("name")===this.modelItem.value?e.style.display="block":e.style.display="none"}):e[0].style.display="block",E.refreshChildren(this)}toggle(e){const t=this.querySelectorAll("fx-case");Array.from(t).forEach(t=>{t.style.display=e===t?"block":"none"})}}window.customElements.define("fx-switch",P);customElements.define("fx-trigger",class extends O{connectedCallback(){this.attachShadow({mode:"open"}),this.ref=this.hasAttribute("ref")?this.getAttribute("ref"):null;this.shadowRoot.innerHTML=`\n                <style>\n                    \n          :host {\n            cursor:pointer;\n          }\n        \n                </style>\n                ${this.renderHTML()}\n        `;const e=this.shadowRoot.querySelector("slot");e.addEventListener("slotchange",()=>{const t=e.assignedElements({flatten:!0});t[0].setAttribute("tabindex","0"),t[0].setAttribute("role","button");const s=t[0];s.addEventListener("click",e=>this.performActions(e)),"BUTTON"!==s.nodeName&&s.addEventListener("keypress",e=>{"Space"!==e.code&&"Enter"!==e.code||this.performActions(e)})})}renderHTML(){return"\n            <slot></slot>\n    "}performActions(e){console.log("performActions ",this.children);const t=this.closest("fx-repeatitem");t&&(console.log("repeated click"),t.click());for(let t=0;t<this.children.length;t+=1){const s=this.children[t];"function"==typeof s.execute&&s.execute(e)}}});class X extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.hasAttribute("label")&&(this.label=this.getAttribute("label")),this.hasAttribute("name")&&(this.name=this.getAttribute("name")),this.hasAttribute("selected")&&(this.selected=this.getAttribute("selected"));const e=`\n           ${this.label?`<span>${this.label}</span>`:""}\n           <slot></slot>\n        `;this.shadowRoot.innerHTML=`\n            <style>\n                \n            :host {\n                display: none;\n            }\n        \n            </style>\n            ${e}\n    `,this.style.display="none"}}window.customElements.define("fx-case",X);class B extends(L(HTMLElement)){constructor(){super(),this.needsUpdate=!1,this.ifCondition=!1}connectedCallback(){this.style.display="none",this.repeatContext=void 0,this.hasAttribute("event")?this.event=this.getAttribute("event"):this.event="activate",this.target=this.getAttribute("target"),this.target?(this.targetElement=document.getElementById(this.target),this.targetElement.addEventListener(this.event,e=>this.execute(e))):(this.targetElement=this.parentNode,this.targetElement.addEventListener(this.event,e=>this.execute(e))),this.ifExpr=this.hasAttribute("if")?this.getAttribute("if"):null}execute(e){this.needsUpdate=!1,this.isBound()&&this.evalInContext(),this.ifExpr?(void 0===this.nodeset&&(this.nodeset=this.targetElement.nodeset),this.ifCondition=T(this.ifExpr,this.nodeset,this.getOwnerForm()),this.ifCondition&&this.perform()):this.perform(),this.actionPerformed()}perform(){(this.isBound()||"FX-ACTION"===this.nodeName)&&this.evalInContext()}actionPerformed(){if(this.needsUpdate){const e=this.getModel();e.recalculate(),e.revalidate(),e.parentNode.refresh(),this._dispatchActionPerformed()}}_dispatchActionPerformed(){this.dispatchEvent(new CustomEvent("action-performed",{composed:!0,bubbles:!0,detail:{}}))}}window.customElements.define("abstracdt-action",B);window.customElements.define("fx-append",class extends B{constructor(){super(),this.repeat=""}connectedCallback(){super.connectedCallback(),console.log("connectedCallback ",this),this.ref=this.getAttribute("ref"),this.repeat=this.getAttribute("repeat")}perform(){super.perform(),this._dataFromTemplate(),this.needsUpdate=!0}actionPerformed(){super.actionPerformed(),this.dispatch()}_dataFromTemplate(){const e=this.getInScopeContext(),t=this.getOwnerForm().querySelector("#"+this.repeat),s=t.shadowRoot.querySelector("template"),n=e.ownerDocument.createElement(t.ref),i=this._generateInstance(s.content,n);t.getInScopeContext().appendChild(i),console.log("appended new item ",i)}dispatch(){let e;E.isRepeated(this)?(console.log("append repeated ",this.repeatContext),e=E.getRepeatTarget(this,this.repeat)):e=document.getElementById(this.repeat),console.log("dispatching index change ",e.nodeset.length),e.dispatchEvent(new CustomEvent("index-changed",{composed:!0,bubbles:!0,detail:{index:e.nodeset.length}}))}_clear(e){let t=e.firstChild;const s=e.attributes;for(let e=0;e<s.length;e+=1)s[e].value="";for(;t;)1===t.nodeType&&t.hasAttributes()&&(t.textContent=""),this._clear(t),t=t.nextSibling}_generateInstance(e,t){if(1===e.nodeType&&e.hasAttribute("ref")){const s=e.getAttribute("ref");let n;"."===s||(s.startsWith("@")?t.setAttribute(s.substring(1),""):(n=document.createElement(s),t.appendChild(n),0===e.children.length&&(n.textContent=e.textContent)))}if(e.hasChildNodes()){const s=e.children;for(let e=0;e<s.length;e+=1)this._generateInstance(s[e],t)}return t}getInstanceId(){return this.ref.startsWith("instance(")?"not implemented":"default"}});window.customElements.define("fx-delete",class extends B{constructor(){super(),this.repeatId=""}perform(){if(super.perform(),console.log("##### fx-delete executing..."),console.log("delete nodeset ",this.nodeset),""===this.repeatId){const e=this.parentNode.closest("fx-repeatitem"),t=Array.from(e.parentNode.children).indexOf(e)+1;this.model=this.getModel();const s=this.parentNode.closest("fx-repeat");let n;n=Array.isArray(this.nodeset)?this.nodeset[t-1]:this.nodeset;n.parentNode.removeChild(n),e.parentNode.removeChild(e);const{repeatSize:i}=s;1===t||1===i?s.setIndex(1):t>i?s.setIndex(i):s.setIndex(t)}this.needsUpdate=!0}});window.customElements.define("fx-message",class extends B{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){super.connectedCallback(),this.event=this.hasAttribute("event")?this.getAttribute("event"):"",this.level=this.hasAttribute("level")?this.getAttribute("level"):"ephemeral";this.shadowRoot.innerHTML=`\n        <style>\n            \n        :host{\n            display:none;\n        }\n    \n        </style>\n        ${this.renderHTML()}\n    `}disconnectedCallback(){this.targetElement.removeEventListener(this.event,e=>this.execute(e))}renderHTML(){return"\n        <slot></slot>\n    "}perform(){const e=this.textContent;this.dispatchEvent(new CustomEvent("message",{composed:!0,bubbles:!0,detail:{level:this.level,message:e}}))}});window.customElements.define("fx-setvalue",class extends B{static get properties(){return{...super.properties,ref:{type:String},value:{type:String}}}constructor(){super(),this.ref="",this.value=""}connectedCallback(){if(super.connectedCallback&&super.connectedCallback(),!this.hasAttribute("ref"))throw new Error('fx-setvalue must specify a "ref" attribute');this.ref=this.getAttribute("ref"),this.value=this.getAttribute("value")}perform(){super.perform();let{value:e}=this;e=null!==this.value?this.value:""!==this.textContent?this.textContent:"";const t=this.getModelItem();this.setValue(t,e)}setValue(e,t){console.log("setvalue[1]  ",e,t);const s=e;s&&s.value!==t&&(s.value=t,s.changed=!0,this.needsUpdate=!0,console.log("setvalue[2] ",s,t))}});window.customElements.define("fx-send",class extends B{constructor(){super(),this.value=""}connectedCallback(){super.connectedCallback(),console.log("connectedCallback ",this),this.submission=this.getAttribute("submission")}perform(){super.perform(),console.log("submitting ",this.submission),console.log("submitting model",this.getModel());const e=this.getModel().querySelector("#"+this.submission);if(null===e)throw this.dispatchEvent(new CustomEvent("error",{composed:!0,bubbles:!0,detail:{message:`fx-submission element with id: '${this.submission}' not found`}})),new Error(`submission with id: ${this.submission} not found`);console.log("submission",e),e.submit()}});class H extends B{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){super.connectedCallback(),this.src=this.hasAttribute("src")?this.getAttribute("src"):null;this.shadowRoot.innerHTML="\n        <style>\n            \n        :host{\n            display:none;\n        }\n    \n        </style>\n        <slot></slot>\n    "}perform(){const{children:e}=this;if(this.src){this.innerHTML="",console.log("### fx-script.perform ");const e=document.createElement("script");e.src=this.src,this.appendChild(e)}else Array.from(e).forEach(e=>{e.perform()}),this.needsUpdate=!0}}window.customElements.define("fx-action",H);window.customElements.define("fx-toggle",class extends H{connectedCallback(){this.hasAttribute("case")&&(this.case=this.getAttribute("case"))}execute(){if(console.log("### fx-toggle.execute "),this.case){const e=this.getOwnerForm().querySelector("#"+this.case);e.parentNode.toggle(e)}}});window.customElements.define("fx-dispatch",class extends B{constructor(){super(),this.event=null,this.targetid=null,this.details=null,this.attachShadow({mode:"open"})}connectedCallback(){if(this.event=this.getAttribute("event"),!this.event)throw new Error("no event specified for dispatch",this);this.targetid=this.hasAttribute("targetid")?this.getAttribute("targetid"):null}perform(){console.log("### fx-dispatch.perform ",this);const e=this.querySelectorAll("fx-property");let t={};if(Array.from(e).forEach(e=>{console.log("prop ",e);const s=e.getAttribute("name"),n=e.getAttribute("value"),i=e.getAttribute("expr");if(i){if(n)throw new Error('if "expr" is given there must not be a "value" attribute');const e=A(i,this.getInScopeContext(),this.getOwnerForm());let o=null;if(e.nodeName){o=(new XMLSerializer).serializeToString(e)}t[s]=o||e}n&&(t[s]=n)}),console.log("details ",t),this.targetid){const e=document.getElementById(this.targetid);if(!e)throw new Error(`targetid ${this.targetid} does not exist in document`);e.dispatchEvent(new CustomEvent(this.event,{composed:!0,bubbles:!0,detail:t}))}else document.dispatchEvent(new CustomEvent(this.event,{composed:!0,bubbles:!0,detail:t}))}});class $ extends(L(HTMLElement)){constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.style.display="none",this.signature=this.hasAttribute("signature")?this.getAttribute("signature"):null,null===this.signature&&console.error("signature is a required attribute"),this.type=this.hasAttribute("type")?this.getAttribute("type"):null,this.shadowRoot.innerHTML="<slot></slot>",this.override=this.hasAttribute("override")?this.getAttribute("override"):"true",this.functionBody=this.innerText;const e=this.getAttribute("type")||"text/xpath",t=this.signature.match(/(?:(?<prefix>[^:]*):)?(?<localName>[^(]+)\((?<params>[^)]*)\)(?: as (?<returnType>.*))?/);if(!t)throw new Error(`Function signature ${this.signature} could not be parsed`);const{prefix:n,localName:i,params:o,returnType:r}=t.groups,a="local"===n?{namespaceURI:"http://www.w3.org/2005/xquery-local-functions",localName:i}:`${n}:${i}`,l=o?o.split(",").map(e=>{const t=e.match(/(?<variableName>\$[^\s]+)(?:\sas\s(?<varType>.+))/);if(!t)throw new Error(`Param ${e} could not be parsed`);const{variableName:s,varType:n}=t.groups;return{variableName:s,variableType:n||"item()*"}}):[];switch(e){case"text/javascript":{const e=new Function("_domFacade",...l.map(e=>e.variableName),"form",this.functionBody);s(a,l.map(e=>e.variableType),r||"item()*",(...t)=>e.apply(this.getInScopeContext(),[...t,this.getOwnerForm()]));break}case"text/xpath":{const e=(e,...t)=>A(this.functionBody,this.getInScopeContext(),this.getOwnerForm(),l.reduce((e,s,n)=>(e[s.variableName.replace("$","")]=t[n],e),{}));s(a,l.map(e=>e.variableType),r||"item()*",e);break}default:throw new Error(`Unexpected mimetype ${e} for function`)}}}customElements.define("fx-function",$),
/**
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
http://polymer.github.io/LICENSE.txt The complete set of authors may be found at
http://polymer.github.io/AUTHORS.txt The complete set of contributors may be
found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by Google as
part of the polymer project is also subject to an additional IP rights grant
found at http://polymer.github.io/PATENTS.txt
*/
h({_template:u`<style include="prism-theme-default">:host{display:block;box-shadow:0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2);margin-bottom:40px;@apply --demo-snippet;}.demo{display:block;border-bottom:1px solid #e0e0e0;background-color:#fff;margin:0;padding:20px;@apply --demo-snippet-demo;}.code-container{margin:0;background-color:#f5f5f5;font-size:13px;overflow:auto;position:relative;padding:0 20px;@apply --demo-snippet-code;}.code{padding:20px;margin:0;background-color:var(--google-grey-100);font-size:13px;overflow:auto;@apply --demo-snippet-code;}.code>pre{margin:0;padding:0 0 10px 0}button{position:absolute;top:0;right:0;text-transform:uppercase;border:none;cursor:pointer;background:#e0e0e0}</style><prism-highlighter></prism-highlighter><div class="demo"><slot id="content"></slot></div><div class="code-container"><marked-element markdown="[[_markdown]]" id="marked"><div class="code" slot="markdown-html" id="code"></div></marked-element><button id="copyButton" title="copy to clipboard" on-tap="_copyToClipboard">Copy</button></div>`,is:"demo-snippet",properties:{_markdown:{type:String}},attached:function(){this._observer=c(this.$.content).observeNodes(function(e){this._updateMarkdown()}.bind(this))},detached:function(){this._observer&&(c(this.$.content).unobserveNodes(this._observer),this._observer=null)},_updateMarkdown:function(){var e=c(this).queryDistributedElements("template")[0];if(e){var t=this.$.marked.unindent(e.innerHTML);t=(t=t.replace(/ class=""/g,"")).replace(/=""/g,""),this._markdown="```\n"+t+"\n```",e.hasAttribute("is")||(c(this.$.content).unobserveNodes(this._observer),this._observer=null,c(this).appendChild(document.importNode(e.content,!0))),this.dispatchEvent(new CustomEvent("dom-ready"))}else this._markdown=""},_copyToClipboard:function(){var e=document.createRange();e.selectNodeContents(this.$.code);var t=window.getSelection();t.removeAllRanges(),t.addRange(e);var s=!1;try{s=document.execCommand("copy"),this.$.copyButton.textContent="done"}catch(e){console.error(e),this.$.copyButton.textContent="error"}return setTimeout(this._resetCopyButtonState.bind(this),1e3),t.removeAllRanges(),s},_resetCopyButtonState:function(){this.$.copyButton.textContent="copy"}});
/**
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
http://polymer.github.io/LICENSE.txt The complete set of authors may be found at
http://polymer.github.io/AUTHORS.txt The complete set of contributors may be
found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by Google as
part of the polymer project is also subject to an additional IP rights grant
found at http://polymer.github.io/PATENTS.txt
*/
const j=u`<dom-module id="demo-pages-shared-styles"><template><style>body{font-family:Roboto,Noto,sans-serif;font-size:14px;margin:0;padding:24px;background-color:#fafafa}.horizontal-section-container{@apply --layout-horizontal;@apply --layout-center-justified;@apply --layout-wrap;}.vertical-section-container{@apply --layout-vertical;@apply --center-justified;}.centered{max-width:600px;margin-left:auto;margin-right:auto}demo-snippet.centered-demo{--demo-snippet-demo:{@apply --layout-horizontal;@apply --layout-wrap;@apply --layout-center-justified;};}</style></template></dom-module>`;j.setAttribute("style","display: none;"),document.head.appendChild(j.content);
//# sourceMappingURL=fore.js.map
